<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant Médical IA 2.0 - Nexyna</title>
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2196F3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Médical IA">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMzIiIGZpbGw9IiMyMTk2RjMiLz4KPHBhdGggZD0iTTk2IDQ4QzEwNC44MzcgNDggMTEyIDU1LjE2MyAxMTIgNjRWODBIMTI4QzEzNi44MzcgODAgMTQ0IDg3LjE2MyAxNDQgOTZTMTM2LjgzNyAxMTIgMTI4IDExMkgxMTJWMTI4QzExMiAxMzYuODM3IDEwNC44MzcgMTQ0IDk2IDE0NEM4Ny4xNjMgMTQ0IDgwIDEzNi44MzcgODAgMTI4VjExMkg2NEM1NS4xNjMgMTEyIDQ4IDEwNC44MzcgNDggOTZTNTUuMTYzIDgwIDY0IDgwSDgwVjY0QzgwIDU1LjE2MyA4Ny4xNjMgNDggOTYgNDhaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Particules animées d'arrière-plan */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .container {
            position: relative;
            z-index: 10;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            max-width: 1200px;
            width: 95%;
            margin: 20px auto;
            overflow: hidden;
            animation: slideUp 0.8s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shine 3s ease-in-out infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
            100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 15px;
            font-weight: 300;
            position: relative;
            z-index: 2;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 20px rgba(255,255,255,0.5); }
            to { text-shadow: 0 0 30px rgba(255,255,255,0.8); }
        }

        .header p {
            font-size: 1.3em;
            opacity: 0.95;
            position: relative;
            z-index: 2;
        }

        .version-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            backdrop-filter: blur(10px);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 40px;
        }

        .left-panel {
            animation: slideInLeft 0.8s ease-out 0.2s both;
        }

        .right-panel {
            animation: slideInRight 0.8s ease-out 0.4s both;
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .body-diagram {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .body-diagram h3 {
            color: #1976D2;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .body-svg {
            width: 100%;
            max-width: 300px;
            height: auto;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .body-part {
            fill: #e3f2fd;
            stroke: #2196F3;
            stroke-width: 2;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .body-part:hover {
            fill: #2196F3;
            transform: scale(1.05);
            filter: drop-shadow(0 5px 15px rgba(33, 150, 243, 0.4));
        }

        .body-part.selected {
            fill: #f44336;
            stroke: #d32f2f;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .pain-scale {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .pain-scale h4 {
            color: #1976D2;
            margin-bottom: 15px;
            text-align: center;
        }

        .pain-slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: linear-gradient(to right, #4caf50, #ffeb3b, #ff9800, #f44336);
            outline: none;
            margin: 20px 0;
        }

        .pain-slider::-webkit-slider-thumb {
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pain-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .pain-display {
            text-align: center;
            font-size: 2em;
            margin: 15px 0;
            transition: all 0.3s ease;
        }

        .voice-controls {
            background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
        }

        .voice-btn {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            position: relative;
            overflow: hidden;
        }

        .voice-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(76, 175, 80, 0.3);
        }

        .voice-btn.recording {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            animation: recordingPulse 1s ease-in-out infinite;
        }

        @keyframes recordingPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .question-input {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .question-input textarea {
            width: 100%;
            padding: 20px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 120px;
            transition: all 0.3s ease;
        }

        .question-input textarea:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
            transform: scale(1.02);
        }

        .analyze-btn {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 20px auto;
            position: relative;
            overflow: hidden;
        }

        .analyze-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(33, 150, 243, 0.4);
        }

        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .analyze-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transition: all 0.3s ease;
            transform: translate(-50%, -50%);
        }

        .analyze-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
            background: white;
            border-radius: 15px;
            margin: 20px 0;
        }

        .loading.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2196F3, #4caf50);
            width: 0%;
            transition: width 0.3s ease;
            animation: shimmer 2s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: 200px 0; }
        }

        .response-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-left: 5px solid #2196F3;
            display: none;
            grid-column: 1 / -1;
        }

        .response-section.show {
            display: block;
            animation: expandIn 0.6s ease-out;
        }

        @keyframes expandIn {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .response-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .response-icon {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            font-size: 20px;
            animation: bounceIn 0.6s ease-out;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        .emergency-alert {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            animation: emergencyBlink 1s ease-in-out infinite;
        }

        @keyframes emergencyBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .emergency-btn {
            background: white;
            color: #f44336;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-weight: bold;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .emergency-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .disclaimer {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffeaa7;
            border-radius: 15px;
            padding: 20px;
            margin: 30px 0;
            font-size: 14px;
            color: #856404;
            grid-column: 1 / -1;
            animation: fadeIn 0.8s ease-out 0.6s both;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .container {
                margin: 10px;
            }
        }

        /* Effets de typing */
        .typing-effect {
            border-right: 2px solid #2196F3;
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            0%, 50% { border-color: transparent; }
            51%, 100% { border-color: #2196F3; }
        }
    </style>
</head>
<body>
    <!-- Particules d'arrière-plan -->
    <div class="particles" id="particles"></div>

    <div class="container">
        <div class="header">
            <div class="version-badge">v2.0 BETA</div>
            <h1>🏥 Assistant Médical IA</h1>
            <p>Analyse intelligente et interactive de vos symptômes</p>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <!-- Schéma corporel interactif -->
                <div class="body-diagram">
                    <h3>📍 Où avez-vous mal ?</h3>
                    <p>Cliquez sur la zone douloureuse</p>
                    <svg class="body-svg" viewBox="0 0 200 400" id="bodySvg">
                        <!-- Tête -->
                        <circle class="body-part" data-part="tête" cx="100" cy="40" r="25" />
                        <!-- Cou -->
                        <rect class="body-part" data-part="cou" x="90" y="65" width="20" height="15" />
                        <!-- Torse -->
                        <rect class="body-part" data-part="poitrine" x="70" y="80" width="60" height="80" />
                        <!-- Bras gauche -->
                        <rect class="body-part" data-part="bras gauche" x="40" y="90" width="25" height="70" />
                        <!-- Bras droit -->
                        <rect class="body-part" data-part="bras droit" x="135" y="90" width="25" height="70" />
                        <!-- Abdomen -->
                        <rect class="body-part" data-part="abdomen" x="75" y="160" width="50" height="60" />
                        <!-- Jambe gauche -->
                        <rect class="body-part" data-part="jambe gauche" x="75" y="220" width="20" height="100" />
                        <!-- Jambe droite -->
                        <rect class="body-part" data-part="jambe droite" x="105" y="220" width="20" height="100" />
                        <!-- Pieds -->
                        <ellipse class="body-part" data-part="pied gauche" cx="85" cy="340" rx="15" ry="8" />
                        <ellipse class="body-part" data-part="pied droit" cx="115" cy="340" rx="15" ry="8" />
                    </svg>
                    <div id="selectedPart" style="margin-top: 15px; font-weight: bold; color: #1976D2;"></div>
                </div>

                <!-- Échelle de douleur -->
                <div class="pain-scale">
                    <h4>📊 Intensité de la douleur</h4>
                    <input type="range" class="pain-slider" id="painScale" min="0" max="10" value="0">
                    <div class="pain-display" id="painDisplay">😊 0/10</div>
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                        <span>Aucune</span>
                        <span>Modérée</span>
                        <span>Extrême</span>
                    </div>
                </div>

                <!-- Contrôles vocaux -->
                <div class="voice-controls">
                    <h4>🎤 Parlez à l'assistant</h4>
                    <button class="voice-btn" id="voiceBtn">
                        <span id="voiceText">🎤 Cliquez et parlez</span>
                    </button>
                    <div id="voiceResult" style="margin-top: 10px; font-style: italic; color: #666;"></div>
                </div>
            </div>

            <div class="right-panel">
                <!-- Question écrite -->
                <div class="question-input">
                    <h4>✍️ Ou décrivez vos symptômes</h4>
                    <textarea id="questionInput" placeholder="Décrivez précisément vos symptômes, leur début, leur évolution...

Exemple: 'J'ai mal à la tête depuis 2 jours, la douleur s'intensifie le matin, j'ai aussi des nausées...'"></textarea>
                </div>

                <button class="analyze-btn" id="analyzeBtn">
                    🔍 Analyser mes symptômes
                </button>

                <!-- Loading avec progress bar -->
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p id="loadingText">Analyse en cours...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
            </div>

            <!-- Section Réponse -->
            <div class="response-section" id="responseSection">
                <div class="response-header">
                    <div class="response-icon">🩺</div>
                    <h3>Analyse Médicale Complète</h3>
                </div>
                <div id="responseContent"></div>
            </div>

            <!-- Disclaimer -->
            <div class="disclaimer">
                <strong>⚠️ Avertissement médical :</strong> Cet assistant utilise l'intelligence artificielle pour fournir des informations médicales générales. 
                Il ne remplace pas un diagnostic médical professionnel. En cas d'urgence ou de doute, consultez immédiatement un médecin ou appelez le 15 (SAMU).
            </div>
        </div>
    </div>

    <script>
        class MedicalAssistantV2 {
            constructor() {
                this.selectedBodyPart = '';
                this.painLevel = 0;
                this.voiceRecognition = null;
                this.initializeElements();
                this.attachEventListeners();
                this.createParticles();
                this.initializeVoiceRecognition();
            }

            initializeElements() {
                this.bodySvg = document.getElementById('bodySvg');
                this.selectedPartDisplay = document.getElementById('selectedPart');
                this.painScale = document.getElementById('painScale');
                this.painDisplay = document.getElementById('painDisplay');
                this.voiceBtn = document.getElementById('voiceBtn');
                this.voiceText = document.getElementById('voiceText');
                this.voiceResult = document.getElementById('voiceResult');
                this.questionInput = document.getElementById('questionInput');
                this.analyzeBtn = document.getElementById('analyzeBtn');
                this.loading = document.getElementById('loading');
                this.loadingText = document.getElementById('loadingText');
                this.progressFill = document.getElementById('progressFill');
                this.responseSection = document.getElementById('responseSection');
                this.responseContent = document.getElementById('responseContent');
            }

            attachEventListeners() {
                // Schéma corporel
                this.bodySvg.addEventListener('click', (e) => {
                    if (e.target.classList.contains('body-part')) {
                        this.selectBodyPart(e.target);
                    }
                });

                // Échelle de douleur
                this.painScale.addEventListener('input', (e) => {
                    this.updatePainLevel(e.target.value);
                });

                // Reconnaissance vocale
                this.voiceBtn.addEventListener('click', () => {
                    this.toggleVoiceRecognition();
                });

                // Analyse
                this.analyzeBtn.addEventListener('click', () => {
                    this.analyzeSymptoms();
                });

                // Enter pour analyser
                this.questionInput.addEventListener('keypress', (e) => {
                    if (e.ctrlKey && e.key === 'Enter') {
                        this.analyzeSymptoms();
                    }
                });
            }

            createParticles() {
                const particlesContainer = document.getElementById('particles');
                for (let i = 0; i < 20; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = Math.random() * 100 + '%';
                    particle.style.width = Math.random() * 10 + 5 + 'px';
                    particle.style.height = particle.style.width;
                    particle.style.animationDelay = Math.random() * 6 + 's';
                    particle.style.animationDuration = (Math.random() * 4 + 4) + 's';
                    particlesContainer.appendChild(particle);
                }
            }

            selectBodyPart(element) {
                // Retirer sélection précédente
                document.querySelectorAll('.body-part').forEach(part => {
                    part.classList.remove('selected');
                });

                // Ajouter nouvelle sélection
                element.classList.add('selected');
                this.selectedBodyPart = element.dataset.part;
                this.selectedPartDisplay.textContent = `Zone sélectionnée : ${this.selectedBodyPart}`;
                
                // Effet sonore (si supporté)
                this.playClickSound();
            }

            updatePainLevel(level) {
                this.painLevel = level;
                const emojis = ['😊', '😐', '😐', '😟', '😟', '😣', '😣', '😖', '😖', '😫', '😱'];
                const colors = ['#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800', '#ff5722', '#f44336', '#e91e63', '#9c27b0', '#673ab7'];
                
                this.painDisplay.textContent = `${emojis[level]} ${level}/10`;
                this.painDisplay.style.color = colors[level];
                
                if (level >= 8) {
                    this.painDisplay.style.animation = 'pulse 0.5s ease-in-out infinite';
                } else {
                    this.painDisplay.style.animation = 'none';
                }
            }

            initializeVoiceRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.voiceRecognition = new SpeechRecognition();
                    this.voiceRecognition.lang = 'fr-FR';
                    this.voiceRecognition.continuous = false;
                    this.voiceRecognition.interimResults = false;

                    this.voiceRecognition.onstart = () => {
                        this.voiceBtn.classList.add('recording');
                        this.voiceText.textContent = '🔴 Parlez maintenant...';
                        this.voiceResult.textContent = '';
                    };

                    this.voiceRecognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        this.questionInput.value = transcript;
                        this.voiceResult.textContent = `Reconnu: "${transcript}"`;
                        this.typeEffect(this.questionInput, transcript);
                    };

                    this.voiceRecognition.onerror = (event) => {
                        this.voiceResult.textContent = 'Erreur de reconnaissance vocale';
                        this.resetVoiceButton();
                    };

                    this.voiceRecognition.onend = () => {
                        this.resetVoiceButton();
                    };
                } else {
                    this.voiceBtn.style.display = 'none';
                    document.querySelector('.voice-controls').innerHTML = '<p>🚫 Reconnaissance vocale non supportée</p>';
                }
            }

            toggleVoiceRecognition() {
                if (this.voiceRecognition) {
                    if (this.voiceBtn.classList.contains('recording')) {
                        this.voiceRecognition.stop();
                    } else {
                        this.voiceRecognition.start();
                    }
                }
            }

            resetVoiceButton() {
                this.voiceBtn.classList.remove('recording');
                this.voiceText.textContent = '🎤 Cliquez et parlez';
            }

            typeEffect(element, text) {
                element.value = '';
                element.classList.add('typing-effect');
                let i = 0;
                const typeInterval = setInterval(() => {
                    element.value += text.charAt(i);
                    i++;
                    if (i > text.length) {
                        clearInterval(typeInterval);
                        element.classList.remove('typing-effect');
                    }
                }, 50);
            }

            async analyzeSymptoms() {
                const question = this.questionInput.value.trim();
                
                if (!question && !this.selectedBodyPart) {
                    alert('Veuillez décrire vos symptômes ou sélectionner une zone sur le corps');
                    return;
                }

                this.showLoading();

                try {
                    await this.simulateAnalysis();
                    const response = this.generateAdvancedResponse(question);
                    this.showResponse(response);
                } catch (error) {
                    this.showError(error.message);
                } finally {
                    this.hideLoading();
                }
            }

            async simulateAnalysis() {
                const steps = [
                    'Analyse des symptômes...',
                    'Consultation de la base médicale...',
                    'Évaluation des risques...',
                    'Génération des recommandations...',
                    'Finalisation du diagnostic...'
                ];

                for (let i = 0; i < steps.length; i++) {
                    this.loadingText.textContent = steps[i];
                    this.progressFill.style.width = ((i + 1) / steps.length) * 100 + '%';
                    await new Promise(resolve => setTimeout(resolve, 800));
                }
            }

            generateAdvancedResponse(question) {
                const lowerQuestion = question.toLowerCase();
                const bodyPart = this.selectedBodyPart;
                const painLevel = this.painLevel;

                // Construire le contexte complet
                let context = '';
                if (bodyPart) context += `Zone affectée: ${bodyPart}. `;
                if (painLevel > 0) context += `Niveau de douleur: ${painLevel}/10. `;

                // Détection d'urgence basée sur douleur + zone
                if (painLevel >= 8 || this.detectEmergency(lowerQuestion, bodyPart)) {
                    return this.generateEmergencyResponse(question, context);
                }

                // Réponses spécialisées par zone corporelle
                if (bodyPart) {
                    return this.generateBodyPartResponse(bodyPart, painLevel, question);
                }

                // Réponses par symptômes
                if (lowerQuestion.includes('mal de tête') || lowerQuestion.includes('céphalée')) {
                    return this.generateHeadacheResponse(painLevel);
                }

                if (lowerQuestion.includes('fièvre') || lowerQuestion.includes('température')) {
                    return this.generateFeverResponse();
                }

                return this.generateGeneralResponse(question, context);
            }

            detectEmergency(question, bodyPart) {
                const emergencyKeywords = [
                    'difficulté respirer', 'essoufflement', 'souffle court',
                    'douleur thoracique', 'mal poitrine', 'serrement',
                    'perte conscience', 'évanouissement', 'syncope',
                    'saignement abondant', 'hémorragie',
                    'paralysie', 'engourdissement soudain',
                    'convulsion', 'crise épilepsie'
                ];

                const emergencyBodyParts = ['poitrine', 'cou'];

                return emergencyKeywords.some(keyword => question.includes(keyword)) ||
                       emergencyBodyParts.includes(bodyPart);
            }

            generateEmergencyResponse(question, context) {
                return `
                    <div class="emergency-alert">
                        <h3>🚨 URGENCE MÉDICALE DÉTECTÉE</h3>
                        <p><strong>Vos symptômes nécessitent une prise en charge immédiate</strong></p>
                        <button class="emergency-btn" onclick="window.open('tel:15')">📞 Appeler le 15 (SAMU)</button>
                        <button class="emergency-btn" onclick="window.open('tel:18')">🚒 Appeler les Pompiers</button>
                    </div>

                    <h4>🎯 Analyse de votre situation</h4>
                    <p><strong>Contexte identifié :</strong> ${context}</p>
                    <p><strong>Symptômes rapportés :</strong> "${question}"</p>

                    <p><strong>⚠️ ACTIONS IMMÉDIATES :</strong></p>
                    <ul>
                        <li>Appelez immédiatement le 15 (SAMU)</li>
                        <li>Restez calme et en sécurité</li>
                        <li>Ne prenez aucun médicament</li>
                        <li>Préparez vos informations médicales</li>
                        <li>Si possible, faites-vous accompagner</li>
                    </ul>

                    <p><strong>📞 Numéros d'urgence :</strong></p>
                    <ul>
                        <li>SAMU : 15</li>
                        <li>Pompiers : 18</li>
                        <li>Urgences européennes : 112</li>
                        <li>SOS Médecins : 3624</li>
                    </ul>
                `;
            }

            generateBodyPartResponse(bodyPart, painLevel, question) {
                const responses = {
                    'tête': `
                        <h4>🧠 Analyse des céphalées - Zone : ${bodyPart}</h4>
                        <p><strong>Intensité rapportée :</strong> ${painLevel}/10</p>
                        
                        ${painLevel >= 7 ? '<div style="background:#ffebee; padding:15px; border-radius:8px; margin:10px 0;"><strong>⚠️ Douleur intense détectée</strong> - Consultation urgente recommandée</div>' : ''}
                        
                        <p><strong>Causes possibles selon l'intensité :</strong></p>
                        <ul>
                            <li>Tension/stress (intensité 1-4)</li>
                            <li>Migraine classique (intensité 5-7)</li>
                            <li>Céphalée secondaire possible (intensité 8-10)</li>
                        </ul>

                        <p><strong>Recommandations personnalisées :</strong></p>
                        <ul>
                            <li>Repos dans un environnement calme</li>
                            <li>Hydratation (2-3 verres d'eau)</li>
                            <li>Compresse froide sur le front</li>
                            ${painLevel <= 5 ? '<li>Paracétamol 1g si nécessaire</li>' : '<li>Consultation médicale recommandée avant automédication</li>'}
                        </ul>
                    `,

                    'poitrine': `
                        <h4>❤️ Analyse des douleurs thoraciques - Zone : ${bodyPart}</h4>
                        <p><strong>⚠️ ATTENTION : Zone nécessitant une évaluation médicale</strong></p>
                        <p><strong>Intensité rapportée :</strong> ${painLevel}/10</p>
                        
                        ${painLevel >= 6 ? this.generateEmergencyResponse(question, `Zone: ${bodyPart}, Douleur: ${painLevel}/10`) : `
                        <p><strong>Évaluation immédiate nécessaire :</strong></p>
                        <ul>
                            <li>Type de douleur : serrement, brûlure, piqûre ?</li>
                            <li>Irradiation vers bras, mâchoire, dos ?</li>
                            <li>Essoufflement associé ?</li>
                            <li>Facteurs déclenchants ?</li>
                        </ul>

                        <p><strong>📞 Consultez rapidement si :</strong></p>
                        <ul>
                            <li>Douleur persistante > 15 minutes</li>
                            <li>Essoufflement important</li>
                            <li>Irradiation vers le bras gauche</li>
                            <li>Malaise associé</li>
                        </ul>
                        `}
                    `,

                    'abdomen': `
                        <h4>🫄 Analyse des douleurs abdominales - Zone : ${bodyPart}</h4>
                        <p><strong>Intensité rapportée :</strong> ${painLevel}/10</p>
                        
                        <p><strong>Localisation plus précise nécessaire :</strong></p>
                        <ul>
                            <li>Haute (estomac, foie, vésicule)</li>
                            <li>Moyenne (intestin grêle, côlon)</li>
                            <li>Basse (appendice, organes pelviens)</li>
                        </ul>

                        <p><strong>Signes d'accompagnement à surveiller :</strong></p>
                        <ul>
                            <li>Nausées, vomissements</li>
                            <li>Fièvre</li>
                            <li>Troubles du transit</li>
                            <li>Ballonnements</li>
                        </ul>

                        ${painLevel >= 7 ? '<p><strong>🚨 Douleur intense : consultation d\'urgence recommandée</strong></p>' : ''}
                    `,

                    'jambe gauche': `
                        <h4>🦵 Analyse - Jambe gauche affectée</h4>
                        <p><strong>Intensité rapportée :</strong> ${painLevel}/10</p>
                        
                        <p><strong>Types de douleurs possibles :</strong></p>
                        <ul>
                            <li>Musculaire (effort, crampe)</li>
                            <li>Articulaire (genou, cheville)</li>
                            <li>Vasculaire (circulation)</li>
                            <li>Nerveuse (sciatique)</li>
                        </ul>

                        <p><strong>Mesures immédiates :</strong></p>
                        <ul>
                            <li>Repos et surélévation</li>
                            <li>Application de froid si traumatisme récent</li>
                            <li>Éviter l'appui si douleur intense</li>
                        </ul>
                    `
                };

                return responses[bodyPart] || this.generateGeneralResponse(question, `Zone: ${bodyPart}, Douleur: ${painLevel}/10`);
            }

            generateHeadacheResponse(painLevel) {
                return `
                    <h4>🧠 Analyse spécialisée des céphalées</h4>
                    <p><strong>Niveau d'intensité :</strong> ${painLevel}/10</p>
                    
                    ${painLevel >= 8 ? '<div class="emergency-alert"><p>🚨 Céphalée très intense - Consultation d\'urgence recommandée</p></div>' : ''}
                    
                    <p><strong>Classification selon l'intensité :</strong></p>
                    <ul>
                        <li>Légère (1-3) : Tension, fatigue</li>
                        <li>Modérée (4-6) : Migraine classique</li>
                        <li>Sévère (7-8) : Migraine forte</li>
                        <li>Extrême (9-10) : Urgence médicale</li>
                    </ul>

                    <p><strong>Plan de traitement personnalisé :</strong></p>
                    <ul>
                        ${painLevel <= 3 ? '<li>Repos, hydratation, relaxation</li>' : ''}
                        ${painLevel >= 4 && painLevel <= 6 ? '<li>Paracétamol ou ibuprofène, repos en environnement calme</li>' : ''}
                        ${painLevel >= 7 ? '<li>Consultation médicale recommandée pour évaluation</li>' : ''}
                    </ul>
                `;
            }

            generateFeverResponse() {
                return `
                    <h4>🌡️ Gestion de la fièvre</h4>
                    
                    <p><strong>Évaluation nécessaire :</strong></p>
                    <ul>
                        <li>Température exacte ?</li>
                        <li>Depuis quand ?</li>
                        <li>Signes associés ?</li>
                    </ul>

                    <p><strong>Conduite à tenir par température :</strong></p>
                    <ul>
                        <li>37.5-38.5°C : Surveillance, hydratation</li>
                        <li>38.5-39.5°C : Antipyrétiques si besoin</li>
                        <li>>39.5°C : Consultation médicale</li>
                        <li>>40°C : Urgence médicale</li>
                    </ul>
                `;
            }

            generateGeneralResponse(question, context) {
                return `
                    <h4>🩺 Analyse médicale personnalisée</h4>
                    
                    ${context ? `<p><strong>Contexte :</strong> ${context}</p>` : ''}
                    <p><strong>Question analysée :</strong> "${question}"</p>
                    
                    <p><strong>Recommandations générales :</strong></p>
                    <ul>
                        <li>Surveillance de l'évolution des symptômes</li>
                        <li>Notation précise des caractéristiques</li>
                        <li>Hydratation adaptée</li>
                        <li>Repos selon les besoins</li>
                    </ul>

                    <p><strong>Consultation recommandée si :</strong></p>
                    <ul>
                        <li>Aggravation des symptômes</li>
                        <li>Nouveaux signes associés</li>
                        <li>Persistance > 48-72h</li>
                        <li>Inquiétude du patient</li>
                    </ul>

                    <p><strong>📞 Contacts utiles :</strong></p>
                    <ul>
                        <li>Médecin traitant (consultation programmée)</li>
                        <li>SOS Médecins : 3624</li>
                        <li>Urgences : 15 (SAMU)</li>
                        <li>Pharmacien pour conseils</li>
                    </ul>
                `;
            }

            showLoading() {
                this.analyzeBtn.disabled = true;
                this.loading.classList.add('show');
                this.responseSection.classList.remove('show');
                this.progressFill.style.width = '0%';
            }

            hideLoading() {
                this.analyzeBtn.disabled = false;
                this.loading.classList.remove('show');
            }

            showResponse(response) {
                this.responseContent.innerHTML = response;
                this.responseSection.classList.add('show');
                
                // Scroll vers la réponse
                this.responseSection.scrollIntoView({ behavior: 'smooth' });
            }

            showError(message) {
                this.responseContent.innerHTML = `
                    <div style="color: #d32f2f; background: #ffebee; padding: 20px; border-radius: 10px;">
                        <strong>❌ Erreur :</strong> ${message}
                    </div>
                `;
                this.responseSection.classList.add('show');
            }

            playClickSound() {
                // Son de clic (si supported)
                try {
                    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSsFJHfH8N2QQAoUXrTp66hVFApGn+zxtGQcBP');
                    audio.volume = 0.1;
                    audio.play();
                } catch (e) {
                    // Silently fail if audio not supported
                }
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            new MedicalAssistantV2();
        });
    </script>

 <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                        
                        setTimeout(() => {
                            if (!window.matchMedia('(display-mode: standalone)').matches) {
                                showInstallPrompt();
                            }
                        }, 3000);
                    })
                    .catch(function(registrationError) {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallPrompt();
        });

        function showInstallPrompt() {
            const installBanner = document.createElement('div');
            installBanner.innerHTML = \`
                <div style="position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #2196F3, #1976D2); color: white; padding: 15px; text-align: center; z-index: 9999; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
                    <p style="margin: 0; font-weight: bold;">📱 Installez l'application sur votre téléphone !</p>
                    <button onclick="installApp()" style="background: white; color: #2196F3; border: none; padding: 8px 20px; border-radius: 20px; margin: 5px; font-weight: bold; cursor: pointer;">Installer</button>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 15px; border-radius: 20px; margin: 5px; cursor: pointer;">Plus tard</button>
                </div>
            \`;
            document.body.appendChild(installBanner);
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('App installée !');
                    }
                    deferredPrompt = null;
                });
            }
        }
    </script>
</body>
</html>   
</body>
</html>
